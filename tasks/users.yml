---
# create user account and add ssh keys via github
- name: ensure group exists
  group: name={{username}} state=present
  sudo: true

- name: ensure user exists
  user:
    name: "{{username}}"
    groups: "{{username}}"
    append: yes
    shell: "{{default_shell}}"
  sudo: true

- name: add ssh key for user
  authorized_key:
    user: "{{username}}"
    key: "{{github_key_url}}"
  tags:
    - ssh

- name: add passwordless sudo to droplets
  template:
    src: sudoers
    dest: /etc/sudoers.d/{{username}}
    owner: root
    group: root
    mode: "0644"
  sudo: true
  when: "'droplets' in group_names"
  tags:
    - sudo

- name: remove passwordless sudo from personal machines
  file:
    path: /etc/sudoers.d/{{username}}
    state: absent
  sudo: true
  when: "'personal' in group_names"
  tags:
    - sudo

- name: tighten up permissions on home directory
  file:
    state: directory
    path: /home/{{ username }}
    mode: "0750"
    owner: "{{ username }}"
    group: "{{ username }}"
